<?phpsession_start();header("Expires: Mon, 26 Jul 1970 05:00:00 GMT");header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");header("Cache-Control: no-cache, must-revalidate");header("Pragma: no-cache");header("Content-type: text/html; charset=utf-8");require_once("../include/config.inc.php");include_once ("../include/address.mem.php");include_once ("../include/tools/FileUpload.php");checkAdminLogin(); // 同一账号不能同时登陆if( !isset($_SESSION['Oid']) || $_SESSION['Oid'] == "" || !isset($_SESSION['is_admin']) || $_SESSION['is_admin'] != ADMINLOGINFLAG ) {    echo "<script>alert('您的登录信息已过期,请重新登录!');top.location.href='/';</script>";    exit;}$id = $_REQUEST['id'];$uid = $_REQUEST["uid"];$langx = $_SESSION["langx"];$loginname = $_SESSION['UserName'];$type = $_REQUEST['type'];$now = date('Y-m-d H:i:s');$sql = "SELECT * FROM " . DBPREFIX . "web_pconfig WHERE `id`=" . $id;$result = mysqli_query($dbLink, $sql);$row = mysqli_fetch_assoc($result);$categorySql = "SELECT `id`, `name`, `tag` FROM " . DBPREFIX . "web_picture_category WHERE status=1";$categoryResult = mysqli_query($dbLink, $categorySql);$categoryList = array();while ($categoryRow = mysqli_fetch_assoc($categoryResult)){    $categoryList[$categoryRow['id']] = $categoryRow;}$aWebsites = explode(',', $row['website']); // 1：PC；2：Mobile；3：ADif($type == 'edit'){ // 基本记录设置    $categoryId = $_POST['category_id'];    $key = $categoryList[$categoryId]['tag'];  //图片标识    $aWebsite = $_POST['website']; // 适用站点    $sWebsite = implode(',', $aWebsite);    $status = $_POST['status'];    $remark = $_REQUEST['remark'];  //备注    $now = date('Y-m-d H:i:s');    // 上传图片    $oldPicImg = $_POST['old_pic_img'];    $oPic = new FileUpload('pic_url','/page');    $pic_url = $oPic->uploads($oldPicImg);    if(!$pic_url){        $pic_url = $oldPicImg;    }    if(in_array(4, $aWebsite) && $oPic->fileerror) {    //if($oPic->fileerror) {        exit("<script> alert('" . $oPic->fileerror . "');history.back();</script>");    }    $sql = "UPDATE `" . DBPREFIX . "web_pconfig` SET `key`='{$key}',`pic_url`='{$pic_url}',`category_id`='{$categoryId}',`website`='{$sWebsite}',            `status`='{$status}',`remark`='{$remark}',`updated_at`='{$now}' WHERE `id` = {$id}";    $result = mysqli_query($dbMasterLink, $sql);    if($result){        refreshPicCache();        echo "<script> alert('更新成功！'); location.href='picture.php?uid=$uid&lv=$lv&langx=$langx';</script>";    }else{        echo "<script> alert('更新失败！'); history.back();</script>";    }}// 更新图片缓存function refreshPicCache(){    global $dbMasterLink;    $sql = "SELECT `id`, `key`, `pic_url`, `category_id`, `remark` FROM " . DBPREFIX . "web_pconfig WHERE status = 1";    $result = mysqli_query($dbMasterLink, $sql);    $lists = array();    while ($row = mysqli_fetch_assoc($result)) {        $lists[$row['key']] = !empty($row['pic_url']) ? PROMOS_PIC_DOMAIN . $row['pic_url'] : '';    }    $pconfigPicSet = json_encode($lists);    $redisObj = new Ciredis();    $redisObj->setOne('pic_config_set', $pconfigPicSet);}?><html><head>    <title>main</title>    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ">    <link rel="stylesheet" href="../../../style/agents/control_main.css?v=<?php echo AUTOVER; ?>" type="text/css"></head><body ><dl class="main-nav">    <dt>图片编辑</dt>    <dd></dd></dl><div class="main-ui all width_1000">    <form NAME="myFORM" action="picture_edit.php?uid=<?php echo $uid?>&lv=<?php echo $lv?>&langx=<?php echo $langx?>" method="POST" enctype="multipart/form-data">        <INPUT TYPE=HIDDEN NAME="id" VALUE="<?php echo $id?>">        <INPUT TYPE=HIDDEN NAME="type" VALUE="edit">        <table  class="m_tab_ed">            <tr class="m_title_edit">                <td colspan="2" ><h4>图片编辑信息</h4></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed" width="140">图片标识 :</td>                <td align="left" class="name_title">                    <?php echo $row['key']?>                </td>            </tr>            <tr>                <td class="m_co_ed">轮播单页类型：</td>                <td align="left">                    <select  name="category_id" id="category_id" onchange="change(this)">                        <option value="">请选择类型</option>                        <?php foreach ($categoryList as $key => $category){?>                            <option value="<?php echo $key;?>" <?php if($key == $row['category_id']) echo 'selected';?>><?php echo $category['name']?></option>                        <?php }?>                    </select>                    必选，<font color="red"><b>（图片分类）</b></font>且活动在此分类下展示。                </td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">是否启用：</td>                <td align="left">                    是<input type="radio" name="status" value="1" <?php echo ($row['status'] == 1 ? 'checked' : '');?> >&nbsp;&nbsp;&nbsp;                    否<input type="radio" name="status" value="0" <?php echo ($row['status'] == 0 ? 'checked' : '');?>>                </td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed" width="140">图片编辑标题 :</td>                <td align="left" class="name_title">                    <input type="text" name="remark" id="remark" value="<?php echo $row['remark']?>" size="50px" maxlength="50" required/>                    必填，活动主标题,且符合50字。                </td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">优惠活动展示：</td>                <td align="left">                    <input name="website[]" type="checkbox" value="1" <?php echo(in_array(1, $aWebsites) ? 'checked' : '')?> />新版                    <input name="website[]" type="checkbox" value="2" <?php echo(in_array(2, $aWebsites) ? 'checked' : '')?> />旧版                    <input name="website[]" type="checkbox" value="3" <?php echo(in_array(3, $aWebsites) ? 'checked' : '')?> />手机版                    <input name="website[]" type="checkbox" value="4" <?php echo(in_array(4, $aWebsites) ? 'checked' : '')?> />广告版                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;◎选择后请在如下<font color="red"><b>对应位置上传图片</b></font>，图片上传类型<font color="red"><b>（jpeg、jpg、png）</b></font>                </td>            </tr>            <tr class="m_title_edit">                <td colspan="2" ><h4>图片信息</h4></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">图片上传：</td>                <td align="left">                    <?php                    if($row['pic_url']){?>                        <input type="button" class="levelmanage za_button" onClick="show_win('<?php echo $row['pic_url'];?>');" value="图片预览" />                    <?php }?>                    <input name="old_pic_img" value="<?php echo $row['pic_url'];?>" type="hidden" >                    <input type="file" name="pic_url" />                    ◎活动图片：必填，                    <font color="red"><b>微信二维码图片尺寸：258X258</b></font>                    <font color="red"><b>APP下载尺寸：260X260</b></font>                </td>            </tr>            <tr class="m_bc_ed" align="center">                <td colspan="2">                    <input type=SUBMIT name="OK" value="确定" class="za_button">                    &nbsp; &nbsp; &nbsp;                    <input type=BUTTON name="FormsButton" value="取消" id="FormsButton" onClick="window.location.replace('picture.php?uid=<?php echo $uid?>&lv=<?php echo $lv?>&langx=<?php echo $langx?>');" class="za_button">                </td>            </tr>        </table>    </form></div><script type="text/javascript" src="../../../js/agents/jquery.js"></script><script type="text/javascript" src="../../../js/agents/layer/layer.js"></script><script type="text/javascript">    function change(obj) {        var categoryId = $(obj).val();        if (categoryId == 7) { // 自动领取            $('.api_url').show();            $('.flag').show();        } else {            $('.api_url').hide();            $('.flag').hide();        }    }    function show_win(pic) {        var picUrl = '<?php echo HTTPS_HEAD.'://'.$_SERVER['HTTP_HOST'].'/uploads'; ?>' + pic;        var str = '<img src="'+picUrl+'" style="width: 100%;">';        layer.open({            type: 1,            title:'图片预览',            skin: 'layui-layer-gameplay',            anim: 2, // 动画风格            area: ['600px', '400px'],            content: str,            shadeClose: true,            shade: 0.5,            yes: function(){                layer.closeAll();            }        });    }</script></body></html>