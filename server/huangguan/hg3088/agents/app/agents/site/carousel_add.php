<?phpsession_start();header("Expires: Mon, 26 Jul 1970 05:00:00 GMT");header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");header("Cache-Control: no-cache, must-revalidate");header("Pragma: no-cache");header("Content-type: text/html; charset=utf-8");require_once("../include/config.inc.php");include_once ("../include/address.mem.php");include_once ("../include/tools/FileUpload.php");checkAdminLogin(); // 同一账号不能同时登陆if( !isset($_SESSION['Oid']) || $_SESSION['Oid'] == "" || !isset($_SESSION['is_admin']) || $_SESSION['is_admin'] != ADMINLOGINFLAG ) {    echo "<script>alert('您的登录信息已过期,请重新登录!');top.location.href='/';</script>";    exit;}$uid = $_REQUEST["uid"];$langx = $_SESSION["langx"];$loginname = $_SESSION['UserName'];$type = $_REQUEST['type'];/*$categorySql = "SELECT `id`, `name`, `tag` FROM " . DBPREFIX . "web_picture_category WHERE status=1";$categoryResult = mysqli_query($dbLink, $categorySql);$categoryList = array();while ($categoryRow = mysqli_fetch_assoc($categoryResult)){    $categoryList[$categoryRow['id']] = $categoryRow;}*/if($type == 'add'){ // 基本记录设置    $title = trim($_REQUEST['title']);    $cartype = isset($_REQUEST['cartype']) ? trim($_REQUEST['cartype']) : 'index'; //轮播种类标识    $categoryId = isset($_REQUEST['category_id']) ? $_REQUEST['category_id'] : 1; //默认轮播    $aWebsite = $_POST['website']; // 适用站点    $sWebsite = implode(',', $aWebsite);    $sitename = !empty($_REQUEST['sitename']) ? trim($_REQUEST['sitename']) : TPL_FILE_NAME;    $status = strval($_REQUEST['status']);    $isShow = strval($_REQUEST['is_show']);    $sequence = $_REQUEST['sequence'];    $now = date('Y-m-d H:i:s');    // 轮播新版    $oCar = new FileUpload('car_url','/'.$sitename . '/carousels');    $car_url = $oCar->uploads();    if($oCar->fileerror) {        exit("<script> alert('" . $oCar->fileerror . "');history.back();</script>");    }    // 轮播手机版    $oCarMobile = new FileUpload('car_url_mobile','/'.$sitename . '/carousels');    $car_url_mobile = $oCarMobile->uploads($oldCarImgMobile);    if(in_array(3, $aWebsite) && $oCarMobile->fileerror) {        exit("<script> alert('" . $oCarMobile->fileerror . "');history.back();</script>");    }    // 轮播广告站    $oCarAd = new FileUpload('car_url_ad','/'.$sitename . '/carousels');    $car_url_ad = $oCarAd->uploads();    if(in_array(4, $aWebsite) && $oCarAd->fileerror) {        exit("<script> alert('" . $oCarAd->fileerror . "');history.back();</script>");    }    $sql = "INSERT INTO `" . DBPREFIX . "web_carousel` VALUES (NULL,'{$title}','{$car_url}','{$car_url_mobile}','{$car_url_ad}','{$cartype}','{$categoryId}','{$sitename}','{$sWebsite}','{$status}','{$isShow}','{$sequence}','{$now}','{$now}')";    $insertId = mysqli_query($dbMasterLink, $sql);    if($insertId){        refreshCarCache();        echo "<script> alert('添加成功！'); location.href='carousel.php?uid=$uid&lv=$lv&langx=$langx';</script>";    }else{        echo "<script> alert('添加失败！');history.back();</script>";    }}// 更新轮播缓存function refreshCarCache(){    global $dbMasterLink;    $sql = "SELECT `id`, `title`, `pic_url`, `pic_url_mobile`, `pic_url_ad`, `cartype`,`category_id`,`sitename`, `website`,`status`,`sequence` FROM " . DBPREFIX . "web_carousel WHERE status = 1 AND `is_show`=1   order by sequence ASC limit 0,100";    $result = mysqli_query($dbMasterLink, $sql);    $data = array();    while ($row = mysqli_fetch_assoc($result)){        $data[]=$row;    }    $bannerPicSet = json_encode($data);    $redisObj = new Ciredis();    $redisObj->setOne('carouse_pic_set', $bannerPicSet);}?><html><head>    <title>main</title>    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ">    <link rel="stylesheet" href="../../../style/agents/control_main.css?v=<?php echo AUTOVER; ?>" type="text/css"></head><body ><dl class="main-nav">    <dt>轮播管理</dt>    <dd></dd></dl><div class="main-ui all width_1000">    <form NAME="myFORM" action="carousel_add.php?uid=<?php echo $uid?>&lv=<?php echo $lv?>&langx=<?php echo $langx?>" method="POST" enctype="multipart/form-data">        <INPUT TYPE=HIDDEN NAME="type" VALUE="add">        <table  class="m_tab_ed">            <tr class="m_title_edit">                <td colspan="2" ><h4>轮播基本信息</h4></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed" width="140">轮播标题：</td>                <td align="left">                    <input type="text" name="title" id="title" value="" size="50px" maxlength="50" required/>                    必填，活动主标题,且符合50字。                </td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed" width="140">种类标识：</td>                <td align="left">                    <input type="text" name="cartype" id="cartype" value="" size="50px" maxlength="50" />                    选填，<font color="red"><b>（轮播种类标识）</b></font>例 index,cgpay,promo。                </td>            </tr>            <!--<tr>                <td class="m_co_ed">轮播类型：</td>                <td align="left">                    <select  name="category_id" id="category_id" onchange="change(this)">                        <option value="">请选择类型</option>                        <?php /*foreach ($categoryList as $key => $category){*/?>                            <option value="<?php /*echo $key;*/?>"><?php /*echo $category['name']*/?></option>                        <?php /*}*/?>                    </select>                    必选，<font color="red"><b>（新版本分类）</b></font>且活动在此分类下展示。                </td>            </tr>-->            <?php            if(in_array(TPL_FILE_NAME , $selectTpl)) {  ?>                <tr class="m_bc_ed">                    <td class="m_co_ed">模板名称：</td>                    <td align="left">                        <select  name="sitename" id="sitename">                            <option value="">请选择类型</option>                            <?php foreach ($siteTplList as $key => $value) { ?>                            <option value="<?php echo $key;?>"><?php echo $value ?></option>                            <?php } ?>                        </select>                    </td>                </tr>            <?php } ?>            <tr class="m_bc_ed">                <td class="m_co_ed">是否启用：</td>                <td align="left">                    是<input type="radio" name="status" value="1" checked >&nbsp;&nbsp;&nbsp;                    否<input type="radio" name="status" value="0" >                </td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">是否轮播图展示：</td>                <td align="left">                    是<input type="radio" name="is_show" value="1" >&nbsp;&nbsp;&nbsp;                    否<input type="radio" name="is_show" value="0" checked >                </td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">排序：</td>                <td align="left"><input class="sequence" type="text" name="sequence" value="0" size="5px"/></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">轮播展示：</td>                <td align="left">                    <input name="website[]" type="checkbox" value="1" checked="checked"/>新版                    <input name="website[]" type="checkbox" value="2" />旧版                    <input name="website[]" type="checkbox" value="3" />手机版                    <input name="website[]" type="checkbox" value="4" />广告版                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;◎选择后请在如下<font color="red"><b>对应位置上传图片</b></font>，图片上传类型<font color="red"><b>（jpeg、jpg、png）</b></font>                </td>            </tr>            <tr class="m_title_edit">                <td colspan="2" ><h4>新旧版</h4></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">轮播图片：</td>                <td align="left">                    <input type="file" name="car_url" />                    ◎活动图片：必填，<font color="red"><b>尺寸：1920X450</b></font>                </td>            </tr>            <tr class="m_title_edit">                <td colspan="2" ><h4>手机版</h4></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">轮播图片 :</td>                <td align="left" class="real_name">                    <input type="file" name="car_url_mobile"/>                    ◎活动图片：必填，<font color="red"><b>尺寸：666X440（手机自适应） </b></font>                </td>            </tr>            <tr class="m_title_edit">                <td colspan="2" ><h4>广告站</h4></td>            </tr>            <tr class="m_bc_ed">                <td class="m_co_ed">轮播图片：</td>                <td align="left">                    <input type="file" name="car_url_ad" />                    ◎活动图片：必填，<font color="red"><b>尺寸：1920X450</b></font>                </td>            </tr>            <tr class="m_bc_ed" align="center">                <td colspan="2">                    <input type=SUBMIT name="OK" value="确定" class="za_button">                    &nbsp; &nbsp; &nbsp;                    <input type=BUTTON name="FormsButton" value="取消" id="FormsButton" onClick="window.location.replace('carousel.php?uid=<?php echo $uid?>&lv=<?php echo $lv?>&langx=<?php echo $langx?>');" class="za_button">                </td>            </tr>        </table>    </form></div><script type="text/javascript" src="../../../js/agents/jquery.js"></script><script type="text/javascript">    function change(obj) {        var categoryId = $(obj).val();        if (categoryId == 7) { // 自动领取            $('.api_url').show();            $('.flag').show();        } else {            $('.api_url').hide();            $('.flag').hide();        }    }</script></body></html>